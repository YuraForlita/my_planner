<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мій Планувальник</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex flex-col items-center">
    <!-- Спінер завантаження -->
    <div id="loading-spinner" class="fixed inset-0 z-50 flex items-center justify-center bg-white bg-opacity-75">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500"></div>
    </div>

    <div class="max-w-xl w-full">
        <div class="bg-white p-6 rounded-2xl shadow-xl">
            <h1 class="text-3xl font-bold text-center mb-4 text-gray-800">Мій Планувальник</h1>
            <p class="text-sm text-gray-500 mb-4 text-center">ID користувача: <span id="user-id-span" class="font-mono">Немає</span></p>

            <!-- Повідомлення про помилку -->
            <div id="error-message" class="hidden bg-red-100 text-red-700 p-4 rounded-lg mb-4">
                Сталася помилка ініціалізації. Будь ласка, спробуйте ще раз.
            </div>

            <!-- Кнопки аутентифікації, видимі, коли користувач не увійшов -->
            <div id="auth-buttons" class="flex flex-col items-center space-y-4 mb-6 hidden">
                <p class="text-gray-500">Будь ласка, увійдіть, щоб зберегти свої завдання.</p>
                <button id="google-signin-btn" class="flex items-center justify-center px-6 py-3 rounded-lg bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-colors shadow-md space-x-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12.24 10.232v3.098h5.364c-.183 1.258-1.554 3.738-5.364 3.738-3.21 0-5.815-2.61-5.815-5.82s2.605-5.82 5.815-5.82c1.724 0 2.872.716 3.518 1.346l2.365-2.285c-1.472-1.39-3.41-2.23-5.883-2.23-4.832 0-8.75 3.92-8.75 8.75s3.918 8.75 8.75 8.75c5.035 0 8.358-3.535 8.358-8.528 0-.583-.075-1.127-.183-1.638h-8.175z"/>
                    </svg>
                    <span>Увійти через Google</span>
                </button>
            </div>

            <!-- Контент додатка, прихований, поки користувач не увійшов -->
            <div id="content-section" class="hidden">
                 <button id="signout-btn" class="w-full text-center mb-4 px-6 py-2 rounded-lg bg-gray-300 text-gray-700 font-semibold hover:bg-gray-400 transition-colors shadow-md">Вийти</button>

                <!-- Кнопки для папок -->
                <div id="folders-container" class="flex flex-wrap gap-2 mb-4">
                    <!-- Кнопки папок будуть додані сюди JS -->
                </div>

                <!-- Введення нового завдання -->
                <div class="flex items-start space-x-2 mb-6">
                    <textarea id="task-input" placeholder="Введіть нове завдання. Додайте #назва для групування, або URL зображення..." rows="3" class="flex-grow px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all resize-none"></textarea>
                    <button id="add-task-btn" class="px-6 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition-colors shadow-md">Додати</button>
                </div>

                <!-- Активні завдання -->
                <div class="bg-blue-50 p-6 rounded-2xl shadow-inner mb-6">
                    <h2 class="text-xl font-bold mb-4 text-gray-700">Активні завдання</h2>
                    <div id="active-tasks" class="space-y-3">
                        <!-- Активні завдання будуть додані сюди JS -->
                    </div>
                </div>

                <!-- Відкладені завдання -->
                <div class="bg-gray-200 p-6 rounded-2xl shadow-inner mb-6">
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xl font-bold text-gray-700">Відкладені завдання</h2>
                        <button id="deferred-tasks-toggle" class="text-sm text-indigo-600 font-semibold hover:underline">Розгорнути</button>
                    </div>
                    <div id="deferred-tasks" class="space-y-3 opacity-60 hidden">
                        <!-- Відкладені завдання будуть додані сюди JS -->
                    </div>
                </div>

                <!-- Виконані завдання -->
                <div class="bg-gray-200 p-6 rounded-2xl shadow-inner mb-6">
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xl font-bold text-gray-700">Виконані завдання</h2>
                        <button id="completed-tasks-toggle" class="text-sm text-indigo-600 font-semibold hover:underline">Розгорнути</button>
                    </div>
                    <div id="completed-tasks" class="space-y-3 opacity-60 hidden">
                        <!-- Виконані завдання будуть додані сюди JS -->
                    </div>
                </div>

                <!-- Налаштування -->
                <div class="bg-white p-6 rounded-2xl shadow-xl mt-6">
                    <div class="flex items-center justify-between mb-2 cursor-pointer" id="settings-toggle-container">
                        <h2 class="text-xl font-bold text-gray-700">Налаштування</h2>
                        <button id="settings-toggle" class="text-sm text-indigo-600 font-semibold hover:underline">Розгорнути налаштування</button>
                    </div>
                    <div id="settings-section" class="hidden">
                        <div class="flex flex-col space-y-2 mb-4">
                            <label for="overdue-hours-input" class="text-sm text-gray-600">Завдання стає "застарілим" через (годин):</label>
                            <input type="number" id="overdue-hours-input" min="1" class="px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                            <label for="defer-hours-input" class="text-sm text-gray-600">Відкладати завдання на (годин):</label>
                            <input type="number" id="defer-hours-input" min="1" class="px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальне вікно для сповіщень -->
    <div id="overdue-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-overlay">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full relative">
            <h3 class="text-lg font-bold mb-2 text-red-600">Нагадування!</h3>
            <p id="overdue-message" class="text-gray-700 whitespace-pre-line"></p>
            <button id="close-overdue-modal" class="mt-4 px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition-colors">Зрозуміло</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.onload = function () {
            // Firebase-об'єкти
            let app;
            let db;
            let auth;
            let userId = null;

            // Змінні Canvas
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            // Елементи DOM
            const taskInput = document.getElementById('task-input');
            const addTaskButton = document.getElementById('add-task-btn');
            const activeTasksList = document.getElementById('active-tasks');
            const deferredTasksList = document.getElementById('deferred-tasks');
            const completedTasksList = document.getElementById('completed-tasks');
            const userIdSpan = document.getElementById('user-id-span');
            const foldersContainer = document.getElementById('folders-container');
            const completedTasksToggle = document.getElementById('completed-tasks-toggle');
            const deferredTasksToggle = document.getElementById('deferred-tasks-toggle');
            const overdueModal = document.getElementById('overdue-modal');
            const overdueMessage = document.getElementById('overdue-message');
            const closeOverdueModal = document.getElementById('close-overdue-modal');
            const overdueHoursInput = document.getElementById('overdue-hours-input');
            const deferHoursInput = document.getElementById('defer-hours-input');
            const settingsToggle = document.getElementById('settings-toggle');
            const settingsSection = document.getElementById('settings-section');
            const loadingSpinner = document.getElementById('loading-spinner');
            const authButtons = document.getElementById('auth-buttons');
            const contentSection = document.getElementById('content-section');
            const googleSignInButton = document.getElementById('google-signin-btn');
            const signOutButton = document.getElementById('signout-btn');
            const errorMessage = document.getElementById('error-message');

            let currentFolder = 'Всі';
            let isCompletedVisible = false;
            let isDeferredVisible = false;
            let isSettingsVisible = false;

            // Налаштування за замовчуванням
            let overdueHours = 72; // 3 дні
            let deferHours = 24; // 1 день

            setLogLevel('debug');

            // Ініціалізація Firebase та аутентифікація
            try {
                if (overdueHoursInput) {
                    overdueHours = localStorage.getItem('overdueHours') ? parseInt(localStorage.getItem('overdueHours')) : 72;
                    overdueHoursInput.value = overdueHours;
                }
                if (deferHoursInput) {
                    deferHours = localStorage.getItem('deferHours') ? parseInt(localStorage.getItem('deferHours')) : 24;
                    deferHoursInput.value = deferHours;
                }

                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is not defined. Cannot initialize.");
                    errorMessage.classList.remove('hidden');
                    loadingSpinner.classList.add('hidden');
                    return;
                }
                
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        if (userIdSpan) userIdSpan.textContent = userId;
                        console.log("Користувач увійшов:", userId);
                        if (authButtons) authButtons.classList.add('hidden');
                        if (contentSection) contentSection.classList.remove('hidden');
                        subscribeToTasks();
                    } else {
                        userId = null;
                        if (userIdSpan) userIdSpan.textContent = 'Немає';
                        console.log("Користувач вийшов.");
                        if (authButtons) authButtons.classList.remove('hidden');
                        if (contentSection) contentSection.classList.add('hidden');
                        renderTasks([]); // Очистити список завдань
                    }
                    if (loadingSpinner) loadingSpinner.classList.add('hidden');
                });

                // Виконання початкового входу за допомогою наданого токена, якщо він є
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Помилка ініціалізації Firebase: ", e);
                if (errorMessage) errorMessage.classList.remove('hidden');
                if (loadingSpinner) loadingSpinner.classList.add('hidden');
            }

            const signInWithGoogle = async () => {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Помилка входу через Google:", error);
                }
            };

            const signOutUser = async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Помилка виходу:", error);
                }
            };

            const subscribeToTasks = () => {
                if (!db || !userId) {
                    console.error("Firestore або ID користувача не ініціалізовано.");
                    return;
                }
                const tasksCollection = collection(db, `artifacts/${appId}/users/${userId}/tasks`);
                // Примітка: для сортування за 'createdAt' (orderBy) потрібно створити індекс у консолі Firebase.
                // Щоб додаток працював відразу, ми тимчасово прибрали сортування.
                const q = query(tasksCollection);

                onSnapshot(q, (querySnapshot) => {
                    const allTasks = [];
                    const folders = new Set(['Всі']);
                    
                    querySnapshot.forEach((doc) => {
                        const task = { id: doc.id, ...doc.data() };
                        allTasks.push(task);
                        if (task.folder) {
                            folders.add(task.folder);
                        }
                    });

                    renderFolders(Array.from(folders));
                    renderTasks(allTasks);
                }, (error) => {
                    console.error("Помилка отримання даних:", error);
                });
            };

            const renderFolders = (folders) => {
                if (!foldersContainer) return;
                foldersContainer.innerHTML = '';
                folders.forEach(folder => {
                    const folderBtn = document.createElement('button');
                    folderBtn.textContent = `#${folder}`;
                    folderBtn.className = `px-3 py-1 rounded-full text-sm font-medium transition-colors ${currentFolder === folder ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`;
                    folderBtn.addEventListener('click', () => {
                        currentFolder = folder;
                        subscribeToTasks(); 
                    });
                    foldersContainer.appendChild(folderBtn);
                });
            };

            const renderTasks = (tasks) => {
                if (!activeTasksList || !deferredTasksList || !completedTasksList) return;
                
                const filteredTasks = tasks.filter(task => currentFolder === 'Всі' || task.folder === currentFolder);

                const activeTasks = [];
                const deferredTasks = [];
                const completedTasks = [];
                const overdueTasks = [];

                const now = new Date().getTime();

                filteredTasks.forEach(task => {
                    if (task.completed) {
                        completedTasks.push(task);
                    } else if (task.deferredUntil && task.deferredUntil.toDate().getTime() > now) {
                        deferredTasks.push(task);
                    } else {
                        activeTasks.push(task);
                        const createdAt = task.createdAt?.toDate().getTime();
                        const hoursOld = createdAt ? (now - createdAt) / (1000 * 60 * 60) : 0;
                        if (hoursOld > overdueHours) {
                            overdueTasks.push(task);
                        }
                    }
                });

                if (overdueTasks.length > 0) {
                    let overdueText = 'Ви давно не працювали над цими завданнями:';
                    overdueTasks.forEach(task => {
                        overdueText += `\n- ${task.text}`;
                    });
                    if (overdueMessage) overdueMessage.textContent = overdueText;
                    if (overdueModal) overdueModal.classList.remove('hidden');
                } else {
                    if (overdueModal) overdueModal.classList.add('hidden');
                }

                renderTaskList(activeTasks, activeTasksList);
                renderTaskList(deferredTasks, deferredTasksList);
                renderTaskList(completedTasks, completedTasksList);
            };

            const renderTaskList = (tasks, listElement) => {
                listElement.innerHTML = '';
                if (tasks.length === 0) {
                    listElement.innerHTML = `<p class="text-gray-500 text-center italic">Немає завдань у цій секції.</p>`;
                    return;
                }

                tasks.forEach(task => {
                    const taskItem = document.createElement('div');
                    let cardColorClass = 'bg-white';
                    
                    const now = new Date().getTime();
                    const createdAt = task.createdAt?.toDate().getTime();
                    const hoursOld = createdAt ? (now - createdAt) / (1000 * 60 * 60) : 0;
                    
                    if (!task.completed && hoursOld > overdueHours) {
                        cardColorClass = 'bg-red-200';
                    }

                    taskItem.className = `p-4 mb-3 rounded-xl shadow-md flex flex-col ${cardColorClass} overflow-hidden`;
                    
                    let buttonsHTML = '';
                    if (!task.completed) {
                        buttonsHTML += `<button class="complete-btn ml-2 px-3 py-1 rounded-full text-sm font-semibold bg-green-500 text-white hover:bg-green-600 transition-colors shadow-sm">Виконано</button>`;
                        buttonsHTML += `<button class="defer-btn ml-2 px-3 py-1 rounded-full text-sm font-semibold bg-yellow-500 text-white hover:bg-yellow-600 transition-colors shadow-sm">В роботі</button>`;
                    }
                    buttonsHTML += `<button class="delete-btn ml-2 px-3 py-1 rounded-full text-sm font-semibold bg-red-500 text-white hover:bg-red-600 transition-colors shadow-sm">Видалити</button>`;

                    const linkRegex = /(https?:\/\/[^\s]+)/g;
                    const taskTextWithLinks = task.text.replace(linkRegex, (url) => {
                        const imageExtensions = ['.png', '.jpg', '.jpeg', '.gif', '.svg', '.webp'];
                        const isImage = imageExtensions.some(ext => url.toLowerCase().endsWith(ext));

                        if (isImage) {
                            return `<a href="${url}" target="_blank" class="text-blue-500 hover:underline break-all">[Зображення]</a>`;
                        } else {
                            return `<a href="${url}" target="_blank" class="text-blue-500 hover:underline break-all">${url}</a>`;
                        }
                    });

                    taskItem.innerHTML = `
                        <div class="flex items-start justify-between mb-2">
                            <span class="text-xs font-semibold text-gray-600">${task.folder ? `#${task.folder}` : ''}</span>
                            <div class="flex-shrink-0 flex items-center">
                                ${buttonsHTML}
                            </div>
                        </div>
                        <p class="text-gray-800 whitespace-pre-wrap flex-grow">${taskTextWithLinks}</p>
                        ${task.imageURL ? `<a href="${task.imageURL}" target="_blank" class="mt-4"><img src="${task.imageURL}" class="mt-4 rounded-lg max-w-full h-auto" alt="Зображення до завдання"></a>` : ''}
                    `;

                    // Обробники подій для кнопок
                    taskItem.querySelector('.delete-btn').addEventListener('click', () => deleteTask(task.id));
                    if (taskItem.querySelector('.complete-btn')) {
                        taskItem.querySelector('.complete-btn').addEventListener('click', () => toggleTaskStatus(task.id, true));
                    }
                    if (taskItem.querySelector('.defer-btn')) {
                        taskItem.querySelector('.defer-btn').addEventListener('click', () => deferTask(task.id));
                    }

                    listElement.appendChild(taskItem);
                });
            };

            const addTask = async () => {
                const taskText = taskInput.value.trim();
                if (taskText === '') return;
                if (!db || !userId) {
                    console.error("Firestore або ID користувача не ініціалізовано. Увійдіть у систему.");
                    return;
                }

                const folderMatch = taskText.match(/^#(\S+)\s*/);
                const folder = folderMatch ? folderMatch[1] : null;
                const cleanText = folderMatch ? taskText.substring(folderMatch[0].length) : taskText;
                
                const imageMatch = cleanText.match(/(https?:\/\/[^\s]+?\.(?:png|jpe?g|gif|svg|webp))/i);
                const imageURL = imageMatch ? imageMatch[0] : null;
                const finalCleanText = imageMatch ? cleanText.replace(imageMatch[0], '') : cleanText;

                try {
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/tasks`), {
                        text: finalCleanText.trim(),
                        completed: false,
                        createdAt: new Date(),
                        folder: folder,
                        imageURL: imageURL,
                        deferredUntil: null
                    });
                    taskInput.value = '';
                    console.log("Завдання додано успішно!");
                } catch (e) {
                    console.error("Помилка додавання завдання: ", e);
                }
            };

            const toggleTaskStatus = async (id, status) => {
                if (!db || !userId) {
                    console.error("Firestore або ID користувача не ініціалізовано. Увійдіть у систему.");
                    return;
                }
                try {
                    const taskRef = doc(db, `artifacts/${appId}/users/${userId}/tasks`, id);
                    await updateDoc(taskRef, {
                        completed: status
                    });
                    console.log("Статус завдання оновлено!");
                } catch (e) {
                    console.error("Помилка оновлення статусу: ", e);
                }
            };
            
            const deferTask = async (id) => {
                if (!db || !userId) {
                    console.error("Firestore або ID користувача не ініціалізовано. Увійдіть у систему.");
                    return;
                }
                try {
                    const deferTime = new Date();
                    deferTime.setHours(deferTime.getHours() + deferHours);
                    
                    const taskRef = doc(db, `artifacts/${appId}/users/${userId}/tasks`, id);
                    await updateDoc(taskRef, {
                        deferredUntil: deferTime
                    });
                    console.log(`Завдання відкладено на ${deferHours} годин.`);
                } catch (e) {
                    console.error("Помилка відкладення завдання: ", e);
                }
            };

            const deleteTask = async (id) => {
                if (!db || !userId) {
                    console.error("Firestore або ID користувача не ініціалізовано. Увійдіть у систему.");
                    return;
                }
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/tasks`, id));
                    console.log("Завдання видалено!");
                } catch (e) {
                    console.error("Помилка видалення завдання: ", e);
                }
            };
            
            const toggleCompletedTasks = () => {
                isCompletedVisible = !isCompletedVisible;
                if (completedTasksList) completedTasksList.classList.toggle('hidden', !isCompletedVisible);
                if (completedTasksToggle) completedTasksToggle.textContent = isCompletedVisible ? 'Згорнути' : 'Розгорнути';
            };

            const toggleDeferredTasks = () => {
                isDeferredVisible = !isDeferredVisible;
                if (deferredTasksList) deferredTasksList.classList.toggle('hidden', !isDeferredVisible);
                if (deferredTasksToggle) deferredTasksToggle.textContent = isDeferredVisible ? 'Згорнути' : 'Розгорнути';
            };

            const toggleSettings = () => {
                isSettingsVisible = !isSettingsVisible;
                if (settingsSection) settingsSection.classList.toggle('hidden', !isSettingsVisible);
                if (settingsToggle) settingsToggle.textContent = isSettingsVisible ? 'Згорнути налаштування' : 'Налаштування';
            };

            // Обробники подій
            if (googleSignInButton) googleSignInButton.addEventListener('click', signInWithGoogle);
            if (signOutButton) signOutButton.addEventListener('click', signOutUser);
            if (addTaskButton) addTaskButton.addEventListener('click', addTask);
            if (taskInput) {
                taskInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        addTask();
                    }
                });
            }
            if (completedTasksToggle) completedTasksToggle.addEventListener('click', toggleCompletedTasks);
            if (deferredTasksToggle) deferredTasksToggle.addEventListener('click', toggleDeferredTasks);
            if (closeOverdueModal) {
                closeOverdueModal.addEventListener('click', () => {
                    overdueModal.classList.add('hidden');
                });
            }
            if (settingsToggle) settingsToggle.addEventListener('click', toggleSettings);
            if (overdueHoursInput) {
                overdueHoursInput.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    overdueHours = value > 0 ? value : 1;
                    localStorage.setItem('overdueHours', overdueHours);
                    subscribeToTasks();
                });
            }
            if (deferHoursInput) {
                deferHoursInput.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    deferHours = value > 0 ? value : 1;
                    localStorage.setItem('deferHours', deferHours);
                });
            }
        };
    </script>
</body>
</html>
